<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Nueva Factura - Facturador</title>
    <link rel="icon" type="image/x-icon" href="../assets/icon.svg" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div class="relative flex size-full min-h-screen flex-col bg-gray-50 group/design-root overflow-x-hidden" style='font-family: Inter, "Noto Sans", sans-serif;'>
      <div class="layout-container flex h-full grow flex-col">
        <!-- Header -->
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#eaedf1] px-10 py-3">
          <div class="flex items-center gap-4 text-[#101518]">
            <div class="size-4">
              <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 4H17.3334V17.3334H30.6666V30.6666H44V44H4V4Z" fill="currentColor"></path></svg>
            </div>
            <h2 class="text-[#101518] text-lg font-bold leading-tight tracking-[-0.015em]">Facturador</h2>
          </div>
          <div class="flex flex-1 justify-end gap-8">
            <div class="flex items-center gap-6">
              <button class="text-[#101518] text-sm font-medium leading-normal hover:text-blue-600" data-navigate="clientes">Clientes</button>
              <button class="text-blue-600 text-sm font-bold leading-normal" data-navigate="appfacturas">Nueva Factura</button>
              <button class="text-[#101518] text-sm font-medium leading-normal hover:text-blue-600" data-navigate="totalfacturas">Facturas</button>
              <button class="text-[#101518] text-sm font-medium leading-normal hover:text-blue-600" data-navigate="subir archivos">Archivos</button>
            </div>
            <div id="userProfile" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 bg-gray-300 flex items-center justify-center cursor-pointer">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24ZM74.08,197.5a64,64,0,0,1,107.84,0,87.83,87.83,0,0,1-107.84,0ZM96,120a32,32,0,1,1,32,32A32,32,0,0,1,96,120Zm97.76,66.41a79.66,79.66,0,0,0-36.06-28.75,48,48,0,1,0-59.4,0,79.66,79.66,0,0,0-36.06,28.75,88,88,0,1,1,131.52,0Z"></path>
              </svg>
            </div>
          </div>
        </header>

        <!-- Main Content -->
        <div class="flex h-full">
          <!-- Sidebar -->
          <nav class="w-64 bg-white border-r border-gray-200 p-4">
            <div class="space-y-2">
              <button class="w-full text-left px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg" data-navigate="clientes">
                <div class="flex items-center gap-3">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M117.25,157.92a60,60,0,1,0-66.5,0A95.83,95.83,0,0,0,3.53,195.63a8,8,0,1,0,13.4,8.74,80,80,0,0,1,134.14,0,8,8,0,0,0,13.4-8.74A95.83,95.83,0,0,0,117.25,157.92ZM40,108a44,44,0,1,1,44,44A44.05,44.05,0,0,1,40,108Zm210.14,98.7a8,8,0,0,1-11.07-2.33A79.83,79.83,0,0,0,172,168a8,8,0,0,1,0-16,44,44,0,1,0-16.34-84.87,8,8,0,1,1-5.94-14.85,60,60,0,0,1,55.53,105.64,95.83,95.83,0,0,1,47.22,37.71A8,8,0,0,1,250.14,206.7Z"></path>
                  </svg>
                  Clientes
                </div>
              </button>
              <button class="w-full text-left px-4 py-2 text-sm font-medium bg-blue-100 text-blue-700 rounded-lg" data-navigate="appfacturas">
                <div class="flex items-center gap-3">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path>
                  </svg>
                  Nueva Factura
                </div>
              </button>
              <button class="w-full text-left px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg" data-navigate="totalfacturas">
                <div class="flex items-center gap-3">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM160,51.31,188.69,80H160ZM200,216H56V40h88V88a8,8,0,0,0,8,8h48V216Z"></path>
                  </svg>
                  Facturas
                </div>
              </button>
              <button class="w-full text-left px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg" data-navigate="subir archivos">
                <div class="flex items-center gap-3">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M224,152a8,8,0,0,1-8,8H192v16a8,8,0,0,1-16,0V160H152a8,8,0,0,1,0-16h24V128a8,8,0,0,1,16,0v16h24A8,8,0,0,1,224,152ZM48,180H76.69L132.69,124a12,12,0,0,1,17,0L176,150.34A8,8,0,1,0,187.31,139L161,112.69a28,28,0,0,0-39.6,0L84.69,150l-15-15A12,12,0,0,0,52.69,135L28,159.65A8,8,0,0,0,39.31,171l20-20,52,52A8,8,0,0,0,117,200H48a8,8,0,0,1,0-16ZM96,88a24,24,0,1,0-24-24A24,24,0,0,0,96,88Z"></path>
                  </svg>
                  Gestión de Archivos
                </div>
              </button>
              <hr class="my-4">
              <button class="w-full text-left px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg" id="logoutBtn">
                <div class="flex items-center gap-3">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M112,216a8,8,0,0,1-8,8H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h56a8,8,0,0,1,0,16H48V208h56A8,8,0,0,1,112,216Zm109.66-93.66-40-40a8,8,0,0,0-11.32,11.32L196.69,120H104a8,8,0,0,0,0,16h92.69l-26.35,26.34a8,8,0,0,0,11.32,11.32l40-40A8,8,0,0,0,221.66,122.34Z"></path>
                  </svg>
                  Cerrar Sesión
                </div>
              </button>
            </div>
          </nav>

          <!-- Content Area -->
          <div class="flex-1 px-8 py-6">
            <div class="max-w-6xl mx-auto">
              <!-- Header -->
              <div class="flex flex-wrap justify-between gap-3 mb-6">
                <div>
                  <h1 class="text-[#101518] tracking-light text-[32px] font-bold leading-tight">Nueva Factura</h1>
                  <p class="text-[#5c748a] text-sm font-normal leading-normal">Crea una nueva factura para tus clientes</p>
                </div>
                <div class="flex gap-3">
                  <button id="saveDraftBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    Guardar Borrador
                  </button>
                  <button id="previewBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    Vista Previa
                  </button>
                  <button id="saveInvoiceBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                    Generar Factura
                  </button>
                </div>
              </div>

              <!-- Invoice Form -->
              <form id="invoiceForm" data-form-type="invoice" class="bg-white rounded-lg border border-gray-200 p-6">
                <!-- Invoice Header -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                  <!-- Invoice Info -->
                  <div class="lg:col-span-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Número de Factura</label>
                        <input 
                          type="text" 
                          name="numero" 
                          id="invoiceNumber"
                          readonly 
                          class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-600"
                        >
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Emisión *</label>
                        <input 
                          type="date" 
                          name="fecha_emision" 
                          required 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Vencimiento</label>
                        <input 
                          type="date" 
                          name="fecha_vencimiento" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                        <select 
                          name="estado" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                          <option value="borrador">Borrador</option>
                          <option value="enviada">Enviada</option>
                          <option value="pagada">Pagada</option>
                          <option value="vencida">Vencida</option>
                          <option value="cancelada">Cancelada</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- Client Selection -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cliente *</label>
                    <div class="flex gap-2">
                      <select 
                        name="client_id" 
                        id="clientSelect"
                        required 
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                        <option value="">Seleccionar cliente...</option>
                      </select>
                      <button 
                        type="button" 
                        id="newClientBtn"
                        class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                        title="Crear nuevo cliente"
                      >
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                          <path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path>
                        </svg>
                      </button>
                    </div>
                    
                    <!-- Client Info Display -->
                    <div id="clientInfo" class="mt-2 p-3 bg-gray-50 rounded-lg text-sm text-gray-600 hidden">
                      <div id="clientDetails"></div>
                    </div>
                  </div>
                </div>

                <!-- Invoice Lines -->
                <div class="mb-8">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Conceptos de la Factura</h3>
                    <button 
                      type="button" 
                      id="addLineBtn"
                      class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2"
                    >
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path>
                      </svg>
                      Agregar Concepto
                    </button>
                  </div>

                  <!-- Invoice Lines Table -->
                  <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                      <thead>
                        <tr class="bg-gray-50">
                          <th class="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">Concepto</th>
                          <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium text-gray-700">Cantidad</th>
                          <th class="border border-gray-300 px-3 py-2 text-right text-sm font-medium text-gray-700">Precio Unit.</th>
                          <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium text-gray-700">IVA %</th>
                          <th class="border border-gray-300 px-3 py-2 text-right text-sm font-medium text-gray-700">Subtotal</th>
                          <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium text-gray-700">Acciones</th>
                        </tr>
                      </thead>
                      <tbody id="invoiceLines">
                        <!-- Las líneas de factura se agregarán dinámicamente aquí -->
                      </tbody>
                    </table>
                  </div>

                  <!-- Add initial line if empty -->
                  <div id="emptyLinesMessage" class="text-center py-8 text-gray-500">
                    <p>No hay conceptos agregados. Haz clic en "Agregar Concepto" para comenzar.</p>
                  </div>
                </div>

                <!-- Totals -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <!-- Notes and Payment Terms -->
                  <div class="space-y-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                      <textarea 
                        name="notas" 
                        rows="3"
                        placeholder="Notas adicionales sobre la factura..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      ></textarea>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Condiciones de Pago</label>
                      <input 
                        type="text" 
                        name="condiciones_pago"
                        placeholder="Ej: Pago a 30 días"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Método de Pago</label>
                      <select 
                        name="metodo_pago" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                        <option value="">Seleccionar método...</option>
                        <option value="transferencia">Transferencia Bancaria</option>
                        <option value="efectivo">Efectivo</option>
                        <option value="tarjeta">Tarjeta de Crédito</option>
                        <option value="cheque">Cheque</option>
                        <option value="bizum">Bizum</option>
                      </select>
                    </div>
                  </div>

                  <!-- Invoice Totals -->
                  <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Resumen de Totales</h4>
                    <div class="space-y-2">
                      <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Subtotal:</span>
                        <span class="text-sm font-medium" id="subtotalAmount">€0.00</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-sm text-gray-600">IVA Total:</span>
                        <span class="text-sm font-medium" id="vatAmount">€0.00</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Descuento:</span>
                        <div class="flex items-center gap-2">
                          <input 
                            type="number" 
                            name="descuento"
                            id="discountInput"
                            min="0" 
                            step="0.01"
                            placeholder="0.00"
                            class="w-20 px-2 py-1 text-xs border border-gray-300 rounded text-right"
                          >
                          <span class="text-sm font-medium">€</span>
                        </div>
                      </div>
                      <hr class="my-2">
                      <div class="flex justify-between">
                        <span class="text-lg font-semibold text-gray-900">Total:</span>
                        <span class="text-lg font-bold text-green-600" id="totalAmount">€0.00</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Hidden fields for totals -->
                <input type="hidden" name="subtotal" id="subtotalHidden">
                <input type="hidden" name="total_iva" id="vatHidden">
                <input type="hidden" name="total" id="totalHidden">
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- New Client Modal -->
    <div id="newClientModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Nuevo Cliente</h3>
          <button id="closeClientModal" class="text-gray-500 hover:text-gray-700">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
              <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm40,144.49L159.51,177,128,145.51,96.49,177,87,167.51,118.49,136,87,104.49,96.49,95,128,126.51,159.51,95,169,104.49,137.51,136,169,167.51Z"></path>
            </svg>
          </button>
        </div>
        
        <form id="quickClientForm" data-form-type="client" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
            <input
              name="nombre"
              type="text"
              required
              placeholder="Nombre del cliente"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input
              name="email"
              type="email"
              placeholder="email@ejemplo.com"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
              <input
                name="telefono"
                type="tel"
                placeholder="555-123-4567"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">NIF/CIF</label>
              <input
                name="nif_cif"
                type="text"
                placeholder="12345678A"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
            <input
              name="direccion"
              type="text"
              placeholder="Calle, número, etc."
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ciudad</label>
              <input
                name="ciudad"
                type="text"
                placeholder="Madrid"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Código Postal</label>
              <input
                name="codigo_postal"
                type="text"
                placeholder="28001"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>
          
          <div class="flex justify-end gap-3 pt-4">
            <button
              type="button"
              id="cancelClientBtn"
              class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              Crear Cliente
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Notification Container -->
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Scripts -->
    <script src="../js/app.js"></script>
    <script>
      // Invoice-specific functionality
      class InvoiceManager {
        constructor() {
          this.lineCounter = 0;
          this.init();
        }

        async init() {
          await this.loadClients();
          await this.generateInvoiceNumber();
          this.setupEventListeners();
          this.setDefaultDates();
          this.addInitialLine();
        }

        async loadClients() {
          try {
            const clients = await ipcRenderer.invoke('db-get-all-clients');
            const clientSelect = document.getElementById('clientSelect');
            
            clientSelect.innerHTML = '<option value="">Seleccionar cliente...</option>';
            
            clients.forEach(client => {
              const option = document.createElement('option');
              option.value = client.id;
              option.textContent = client.nombre;
              option.dataset.clientData = JSON.stringify(client);
              clientSelect.appendChild(option);
            });
          } catch (error) {
            console.error('Error al cargar clientes:', error);
          }
        }

        async generateInvoiceNumber() {
          try {
            const invoiceNumber = await ipcRenderer.invoke('db-generate-invoice-number');
            document.getElementById('invoiceNumber').value = invoiceNumber;
          } catch (error) {
            console.error('Error al generar número de factura:', error);
          }
        }

        setDefaultDates() {
          const today = new Date().toISOString().split('T')[0];
          document.querySelector('[name="fecha_emision"]').value = today;
          
          // Fecha de vencimiento 30 días después
          const dueDate = new Date();
          dueDate.setDate(dueDate.getDate() + 30);
          document.querySelector('[name="fecha_vencimiento"]').value = dueDate.toISOString().split('T')[0];
        }

        setupEventListeners() {
          // Client selection
          document.getElementById('clientSelect').addEventListener('change', (e) => {
            this.showClientInfo(e.target);
          });

          // Add line button
          document.getElementById('addLineBtn').addEventListener('click', () => {
            this.addInvoiceLine();
          });

          // Client modal
          document.getElementById('newClientBtn').addEventListener('click', () => {
            document.getElementById('newClientModal').classList.remove('hidden');
          });

          document.getElementById('closeClientModal').addEventListener('click', () => {
            this.hideClientModal();
          });

          document.getElementById('cancelClientBtn').addEventListener('click', () => {
            this.hideClientModal();
          });

          // Discount input
          document.getElementById('discountInput').addEventListener('input', () => {
            this.calculateTotals();
          });

          // Invoice form buttons
          document.getElementById('saveDraftBtn').addEventListener('click', () => {
            this.saveInvoice('borrador');
          });

          document.getElementById('previewBtn').addEventListener('click', () => {
            this.previewInvoice();
          });

          document.getElementById('saveInvoiceBtn').addEventListener('click', () => {
            this.saveInvoice('enviada');
          });

          // Quick client form
          document.getElementById('quickClientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await this.createQuickClient(e.target);
          });
        }

        showClientInfo(selectElement) {
          const selectedOption = selectElement.selectedOptions[0];
          const clientInfo = document.getElementById('clientInfo');
          const clientDetails = document.getElementById('clientDetails');

          if (selectedOption && selectedOption.dataset.clientData) {
            const client = JSON.parse(selectedOption.dataset.clientData);
            
            clientDetails.innerHTML = `
              <div class="grid grid-cols-1 gap-1">
                <div><strong>Email:</strong> ${client.email || 'No especificado'}</div>
                <div><strong>Teléfono:</strong> ${client.telefono || 'No especificado'}</div>
                <div><strong>Dirección:</strong> ${client.direccion || 'No especificada'}</div>
                ${client.nif_cif ? `<div><strong>NIF/CIF:</strong> ${client.nif_cif}</div>` : ''}
              </div>
            `;
            
            clientInfo.classList.remove('hidden');
          } else {
            clientInfo.classList.add('hidden');
          }
        }

        addInitialLine() {
          this.addInvoiceLine();
        }

        addInvoiceLine(data = {}) {
          this.lineCounter++;
          const tbody = document.getElementById('invoiceLines');
          const emptyMessage = document.getElementById('emptyLinesMessage');
          
          emptyMessage.style.display = 'none';

          const row = document.createElement('tr');
          row.className = 'invoice-line';
          row.dataset.lineId = this.lineCounter;
          
          row.innerHTML = `
            <td class="border border-gray-300 px-2 py-1">
              <input 
                type="text" 
                name="concepto_${this.lineCounter}"
                value="${data.concepto || ''}"
                placeholder="Descripción del producto/servicio"
                class="w-full px-2 py-1 text-sm border-0 focus:ring-0"
                required
              >
            </td>
            <td class="border border-gray-300 px-2 py-1 text-center">
              <input 
                type="number" 
                name="cantidad_${this.lineCounter}"
                value="${data.cantidad || 1}"
                min="0.001" 
                step="0.001"
                class="w-20 px-2 py-1 text-sm text-center border-0 focus:ring-0 line-cantidad"
                required
              >
            </td>
            <td class="border border-gray-300 px-2 py-1">
              <input 
                type="number" 
                name="precio_${this.lineCounter}"
                value="${data.precio_unitario || ''}"
                min="0" 
                step="0.01"
                placeholder="0.00"
                class="w-24 px-2 py-1 text-sm text-right border-0 focus:ring-0 line-precio"
                required
              >
            </td>
            <td class="border border-gray-300 px-2 py-1 text-center">
              <select 
                name="iva_${this.lineCounter}"
                class="w-16 px-1 py-1 text-sm text-center border-0 focus:ring-0 line-iva"
              >
                <option value="0">0%</option>
                <option value="4">4%</option>
                <option value="10">10%</option>
                <option value="21" ${(!data.iva_percentage || data.iva_percentage === 21) ? 'selected' : ''}>21%</option>
              </select>
            </td>
            <td class="border border-gray-300 px-2 py-1 text-right">
              <span class="line-subtotal text-sm font-medium">€0.00</span>
            </td>
            <td class="border border-gray-300 px-2 py-1 text-center">
              <button 
                type="button" 
                class="text-red-600 hover:text-red-800 remove-line-btn"
                onclick="invoiceManager.removeLine(${this.lineCounter})"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM112,168a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm0-120H96V40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8Z"></path>
                </svg>
              </button>
            </td>
          `;

          tbody.appendChild(row);

          // Add event listeners for calculations
          const inputs = row.querySelectorAll('input, select');
          inputs.forEach(input => {
            input.addEventListener('input', () => {
              this.calculateLineTotal(row);
              this.calculateTotals();
            });
          });

          this.calculateLineTotal(row);
          this.calculateTotals();
        }

        removeLine(lineId) {
          const row = document.querySelector(`[data-line-id="${lineId}"]`);
          if (row) {
            row.remove();
            this.calculateTotals();
            
            // Show empty message if no lines left
            const tbody = document.getElementById('invoiceLines');
            if (tbody.children.length === 0) {
              document.getElementById('emptyLinesMessage').style.display = 'block';
            }
          }
        }

        calculateLineTotal(row) {
          const cantidad = parseFloat(row.querySelector('.line-cantidad').value) || 0;
          const precio = parseFloat(row.querySelector('.line-precio').value) || 0;
          const subtotal = cantidad * precio;
          
          row.querySelector('.line-subtotal').textContent = `€${subtotal.toFixed(2)}`;
        }

        calculateTotals() {
          let subtotal = 0;
          let totalIva = 0;

          document.querySelectorAll('.invoice-line').forEach(row => {
            const cantidad = parseFloat(row.querySelector('.line-cantidad').value) || 0;
            const precio = parseFloat(row.querySelector('.line-precio').value) || 0;
            const ivaPercent = parseFloat(row.querySelector('.line-iva').value) || 0;
            
            const lineSubtotal = cantidad * precio;
            const lineIva = lineSubtotal * (ivaPercent / 100);
            
            subtotal += lineSubtotal;
            totalIva += lineIva;
          });

          const descuento = parseFloat(document.getElementById('discountInput').value) || 0;
          const total = subtotal + totalIva - descuento;

          // Update display
          document.getElementById('subtotalAmount').textContent = `€${subtotal.toFixed(2)}`;
          document.getElementById('vatAmount').textContent = `€${totalIva.toFixed(2)}`;
          document.getElementById('totalAmount').textContent = `€${total.toFixed(2)}`;

          // Update hidden fields
          document.getElementById('subtotalHidden').value = subtotal.toFixed(2);
          document.getElementById('vatHidden').value = totalIva.toFixed(2);
          document.getElementById('totalHidden').value = total.toFixed(2);
        }

        async createQuickClient(form) {
          try {
            const formData = new FormData(form);
            const clientData = Object.fromEntries(formData.entries());
            
            const newClient = await ipcRenderer.invoke('db-create-client', clientData);
            
            // Add to client select
            const clientSelect = document.getElementById('clientSelect');
            const option = document.createElement('option');
            option.value = newClient.id;
            option.textContent = newClient.nombre;
            option.dataset.clientData = JSON.stringify(newClient);
            clientSelect.appendChild(option);
            
            // Select the new client
            clientSelect.value = newClient.id;
            this.showClientInfo(clientSelect);
            
            // Hide modal and reset form
            this.hideClientModal();
            form.reset();
            
            if (window.app) {
              window.app.showNotification('Cliente creado exitosamente', 'success');
            }
          } catch (error) {
            console.error('Error al crear cliente:', error);
            if (window.app) {
              window.app.showNotification('Error al crear cliente: ' + error.message, 'error');
            }
          }
        }

        hideClientModal() {
          document.getElementById('newClientModal').classList.add('hidden');
          document.getElementById('quickClientForm').reset();
        }

        async saveInvoice(estado = 'borrador') {
          const form = document.getElementById('invoiceForm');
          const formData = new FormData(form);
          
          try {
            // Validate required fields
            if (!formData.get('client_id')) {
              throw new Error('Debe seleccionar un cliente');
            }

            const lines = this.getInvoiceLines();
            if (lines.length === 0) {
              throw new Error('Debe agregar al menos un concepto a la factura');
            }

            // Prepare invoice data
            const invoiceData = {
              numero: formData.get('numero'),
              client_id: parseInt(formData.get('client_id')),
              fecha_emision: formData.get('fecha_emision'),
              fecha_vencimiento: formData.get('fecha_vencimiento'),
              subtotal: parseFloat(formData.get('subtotal')),
              total_iva: parseFloat(formData.get('total_iva')),
              total: parseFloat(formData.get('total')),
              descuento: parseFloat(formData.get('descuento')) || 0,
              estado: estado,
              notas: formData.get('notas'),
              condiciones_pago: formData.get('condiciones_pago'),
              metodo_pago: formData.get('metodo_pago')
            };

            // Save invoice
            const savedInvoice = await ipcRenderer.invoke('db-create-invoice', invoiceData);

            // Save invoice lines
            for (const line of lines) {
              await ipcRenderer.invoke('db-add-invoice-line', savedInvoice.id, line);
            }

            if (window.app) {
              window.app.showNotification(`Factura ${estado === 'borrador' ? 'guardada como borrador' : 'creada'} exitosamente`, 'success');
            }

            // Navigate to invoices list
            setTimeout(() => {
              if (window.app) {
                window.app.navigateTo('totalfacturas');
              }
            }, 2000);

          } catch (error) {
            console.error('Error al guardar factura:', error);
            if (window.app) {
              window.app.showNotification('Error al guardar factura: ' + error.message, 'error');
            }
          }
        }

        getInvoiceLines() {
          const lines = [];
          document.querySelectorAll('.invoice-line').forEach((row, index) => {
            const lineId = row.dataset.lineId;
            const concepto = row.querySelector(`[name="concepto_${lineId}"]`).value;
            const cantidad = parseFloat(row.querySelector(`[name="cantidad_${lineId}"]`).value);
            const precio = parseFloat(row.querySelector(`[name="precio_${lineId}"]`).value);
            const iva = parseFloat(row.querySelector(`[name="iva_${lineId}"]`).value);
            
            if (concepto && cantidad && precio) {
              const subtotal = cantidad * precio;
              const totalIva = subtotal * (iva / 100);
              const total = subtotal + totalIva;
              
              lines.push({
                concepto: concepto,
                cantidad: cantidad,
                precio_unitario: precio,
                iva_percentage: iva,
                subtotal: subtotal,
                total_iva: totalIva,
                total: total,
                orden: index
              });
            }
          });
          return lines;
        }

        async previewInvoice() {
          try {
            const formData = this.getFormData();
            
            if (!formData.cliente_id) {
              throw new Error('Debe seleccionar un cliente');
            }

            const lines = this.getInvoiceLines();
            if (lines.length === 0) {
              throw new Error('Debe agregar al menos un concepto a la factura');
            }

            // Generate preview HTML
            const previewHtml = await this.generateInvoicePreview(formData, lines);
            
            // Open preview in new window
            const previewWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            previewWindow.document.write(previewHtml);
            previewWindow.document.close();
            
          } catch (error) {
            console.error('Error al generar vista previa:', error);
            window.app.showNotification('Error al generar vista previa: ' + error.message, 'error');
          }
        }

        async generateInvoicePreview(formData, lines) {
          // Get client data
          const clientSelect = document.getElementById('clientSelect');
          const selectedOption = clientSelect.selectedOptions[0];
          const clientData = selectedOption ? JSON.parse(selectedOption.dataset.clientData) : null;

          const subtotal = parseFloat(formData.subtotal);
          const totalIva = parseFloat(formData.total_iva);
          const total = parseFloat(formData.total);

          return `
            <!DOCTYPE html>
            <html>
            <head>
              <title>Vista Previa - Factura ${formData.numero_factura}</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .invoice-info { display: flex; justify-content: space-between; margin-bottom: 30px; }
                .client-info, .company-info { width: 45%; }
                .line-items { width: 100%; border-collapse: collapse; margin: 20px 0; }
                .line-items th, .line-items td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                .line-items th { background-color: #f2f2f2; }
                .totals { text-align: right; margin-top: 20px; }
                .total-row { display: flex; justify-content: flex-end; margin: 5px 0; }
                .total-label { width: 150px; font-weight: bold; }
                .total-value { width: 100px; text-align: right; }
                @media print { body { margin: 0; } }
              </style>
            </head>
            <body>
              <div class="header">
                <h1>FACTURA</h1>
                <h2>Número: ${formData.numero_factura}</h2>
              </div>
              
              <div class="invoice-info">
                <div class="company-info">
                  <h3>Datos de la Empresa</h3>
                  <p><strong>Facturador Pro</strong></p>
                  <p>Dirección de la empresa</p>
                  <p>Teléfono: +34 XXX XXX XXX</p>
                  <p>Email: info@facturador.com</p>
                </div>
                
                <div class="client-info">
                  <h3>Facturar a:</h3>
                  <p><strong>${clientData ? clientData.nombre : 'Cliente no seleccionado'}</strong></p>
                  ${clientData ? `
                    <p>${clientData.email || ''}</p>
                    <p>${clientData.telefono || ''}</p>
                    <p>${clientData.direccion || ''}</p>
                    ${clientData.nif_cif ? `<p>NIF/CIF: ${clientData.nif_cif}</p>` : ''}
                  ` : ''}
                </div>
              </div>
              
              <div class="invoice-details">
                <p><strong>Fecha de emisión:</strong> ${formData.fecha_emision}</p>
                <p><strong>Fecha de vencimiento:</strong> ${formData.fecha_vencimiento}</p>
                ${formData.notas ? `<p><strong>Notas:</strong> ${formData.notas}</p>` : ''}
              </div>
              
              <table class="line-items">
                <thead>
                  <tr>
                    <th>Concepto</th>
                    <th>Cantidad</th>
                    <th>Precio Unit.</th>
                    <th>IVA</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${lines.map(line => `
                    <tr>
                      <td>${line.concepto}</td>
                      <td>${line.cantidad}</td>
                      <td>€${line.precio_unitario.toFixed(2)}</td>
                      <td>${line.iva_percentage}%</td>
                      <td>€${(line.cantidad * line.precio_unitario).toFixed(2)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              
              <div class="totals">
                <div class="total-row">
                  <div class="total-label">Subtotal:</div>
                  <div class="total-value">€${subtotal.toFixed(2)}</div>
                </div>
                <div class="total-row">
                  <div class="total-label">IVA Total:</div>
                  <div class="total-value">€${totalIva.toFixed(2)}</div>
                </div>
                ${formData.descuento && parseFloat(formData.descuento) > 0 ? `
                <div class="total-row">
                  <div class="total-label">Descuento:</div>
                  <div class="total-value">-€${parseFloat(formData.descuento).toFixed(2)}</div>
                </div>
                ` : ''}
                <div class="total-row" style="border-top: 2px solid #000; font-size: 1.2em;">
                  <div class="total-label">TOTAL:</div>
                  <div class="total-value">€${total.toFixed(2)}</div>
                </div>
              </div>
              
              <div style="margin-top: 40px; text-align: center;">
                <button onclick="window.print()">Imprimir</button>
                <button onclick="window.close()">Cerrar</button>
              </div>
            </body>
            </html>
          `;
        }
      }

      // Initialize invoice manager when page loads
      document.addEventListener('DOMContentLoaded', () => {
        window.invoiceManager = new InvoiceManager();
      });
    </script>
  </body>
</html>
