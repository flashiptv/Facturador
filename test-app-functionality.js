// Script de pruebas para verificar funcionalidad de la aplicaci√≥n Facturador
const { app, BrowserWindow } = require('electron');
const path = require('path');

// Importar las clases de base de datos
const JSONDatabase = require('./js/jsonDatabase');
const bcrypt = require('bcryptjs');

class AppTester {
    constructor() {
        this.database = null;
        this.testResults = {
            passed: 0,
            failed: 0,
            tests: []
        };
    }

    async runAllTests() {
        console.log('üß™ Iniciando pruebas de funcionalidad de la aplicaci√≥n Facturador...\n');

        try {
            // Inicializar base de datos de prueba
            await this.initTestDatabase();

            // Ejecutar todas las pruebas
            await this.testDatabaseConnection();
            await this.testUserAuthentication();
            await this.testClientManagement();
            await this.testProductManagement();
            await this.testInvoiceManagement();
            await this.testSettings();
            await this.testDashboardStats();

            // Mostrar resultados
            this.showResults();

        } catch (error) {
            console.error('‚ùå Error durante las pruebas:', error);
        } finally {
            if (this.database) {
                await this.database.close();
            }
        }
    }

    async initTestDatabase() {
        console.log('üìä Inicializando base de datos de prueba...');
        this.database = new JSONDatabase();
        await this.database.init();
        this.addTestResult('Inicializaci√≥n de base de datos', true, 'Base de datos JSON inicializada correctamente');
    }

    async testDatabaseConnection() {
        console.log('\nüîó Probando conexi√≥n a la base de datos...');
        
        try {
            const users = await this.database.getAllUsers();
            this.addTestResult('Conexi√≥n a base de datos', true, `Conexi√≥n exitosa, ${users.length} usuarios encontrados`);
        } catch (error) {
            this.addTestResult('Conexi√≥n a base de datos', false, error.message);
        }
    }

    async testUserAuthentication() {
        console.log('\nüîê Probando sistema de autenticaci√≥n...');

        try {
            // Generar email √∫nico para evitar conflictos
            const uniqueEmail = `test${Date.now()}@test.com`;

            // Probar creaci√≥n de usuario
            const testUser = {
                name: 'Usuario Test',
                email: uniqueEmail,
                password: await bcrypt.hash('test123', 10)
            };

            const createdUser = await this.database.createUser(testUser);
            this.addTestResult('Creaci√≥n de usuario', !!createdUser, createdUser ? 'Usuario creado exitosamente' : 'Error al crear usuario');

            // Probar b√∫squeda por email
            const foundUser = await this.database.getUserByEmail(uniqueEmail);
            this.addTestResult('B√∫squeda de usuario por email', !!foundUser, foundUser ? 'Usuario encontrado' : 'Usuario no encontrado');

            // Probar b√∫squeda por ID
            if (createdUser) {
                const foundById = await this.database.getUserById(createdUser.id);
                this.addTestResult('B√∫squeda de usuario por ID', !!foundById, foundById ? 'Usuario encontrado por ID' : 'Usuario no encontrado por ID');
            }

            // Probar verificaci√≥n de contrase√±a
            if (foundUser) {
                const passwordMatch = await bcrypt.compare('test123', foundUser.password);
                this.addTestResult('Verificaci√≥n de contrase√±a', passwordMatch, passwordMatch ? 'Contrase√±a verificada correctamente' : 'Error en verificaci√≥n de contrase√±a');
            }

        } catch (error) {
            this.addTestResult('Sistema de autenticaci√≥n', false, error.message);
        }
    }

    async testClientManagement() {
        console.log('\nüë• Probando gesti√≥n de clientes...');

        try {
            // Crear cliente de prueba
            const testClient = {
                nombre: 'Cliente Test S.L.',
                email: 'cliente@test.com',
                telefono: '91 123 45 67',
                direccion: 'Calle Test, 123',
                ciudad: 'Madrid',
                codigo_postal: '28001',
                nif_cif: 'B12345678',
                notas: 'Cliente de prueba'
            };

            const createdClient = await this.database.createClient(testClient);
            this.addTestResult('Creaci√≥n de cliente', !!createdClient, createdClient ? 'Cliente creado exitosamente' : 'Error al crear cliente');

            // Obtener todos los clientes
            try {
                const allClients = await this.database.getAllClients();
                this.addTestResult('Obtener todos los clientes', Array.isArray(allClients), `${allClients.length} clientes encontrados`);
            } catch (error) {
                this.addTestResult('Obtener todos los clientes', false, error.message);
            }

            // Buscar cliente por ID
            if (createdClient) {
                try {
                    const foundClient = await this.database.getClientById(createdClient.id);
                    this.addTestResult('B√∫squeda de cliente por ID', !!foundClient, foundClient ? 'Cliente encontrado' : 'Cliente no encontrado');
                } catch (error) {
                    this.addTestResult('B√∫squeda de cliente por ID', false, error.message);
                }

                // Actualizar cliente
                try {
                    const updatedData = { ...testClient, nombre: 'Cliente Test Actualizado S.L.' };
                    const updatedClient = await this.database.updateClient(createdClient.id, updatedData);
                    this.addTestResult('Actualizaci√≥n de cliente', !!updatedClient, updatedClient ? 'Cliente actualizado exitosamente' : 'Error al actualizar cliente');
                } catch (error) {
                    this.addTestResult('Actualizaci√≥n de cliente', false, error.message);
                }

                // Buscar clientes
                try {
                    const searchResults = await this.database.searchClients('Test');
                    this.addTestResult('B√∫squeda de clientes', Array.isArray(searchResults), `${searchResults.length} clientes encontrados en b√∫squeda`);
                } catch (error) {
                    this.addTestResult('B√∫squeda de clientes', false, error.message);
                }
            }

        } catch (error) {
            this.addTestResult('Gesti√≥n de clientes', false, error.message);
        }
    }

    async testProductManagement() {
        console.log('\nüì¶ Probando gesti√≥n de productos...');

        try {
            // Crear producto de prueba
            const testProduct = {
                codigo: 'TEST001',
                nombre: 'Producto Test',
                descripcion: 'Producto de prueba',
                precio: 99.99,
                categoria: 'Test',
                unidad: 'ud',
                iva_percentage: 21.00
            };

            const createdProduct = await this.database.createProduct(testProduct);
            this.addTestResult('Creaci√≥n de producto', !!createdProduct, createdProduct ? 'Producto creado exitosamente' : 'Error al crear producto');

            // Obtener todos los productos
            const allProducts = await this.database.getAllProducts();
            this.addTestResult('Obtener todos los productos', Array.isArray(allProducts), `${allProducts.length} productos encontrados`);

        } catch (error) {
            this.addTestResult('Gesti√≥n de productos', false, error.message);
        }
    }

    async testInvoiceManagement() {
        console.log('\nüßæ Probando gesti√≥n de facturas...');

        try {
            // Generar n√∫mero de factura
            const invoiceNumber = await this.database.generateNextInvoiceNumber();
            this.addTestResult('Generaci√≥n de n√∫mero de factura', !!invoiceNumber, `N√∫mero generado: ${invoiceNumber}`);

            // Obtener todas las facturas
            const allInvoices = await this.database.getAllInvoices();
            this.addTestResult('Obtener todas las facturas', Array.isArray(allInvoices), `${allInvoices.length} facturas encontradas`);

        } catch (error) {
            this.addTestResult('Gesti√≥n de facturas', false, error.message);
        }
    }

    async testSettings() {
        console.log('\n‚öôÔ∏è Probando configuraci√≥n...');

        try {
            // Probar configuraci√≥n de empresa
            const companySettings = {
                company_name: 'Empresa Test S.L.',
                company_nif: 'B87654321',
                company_address: 'Calle Test, 456',
                company_phone: '+34 91 987 65 43',
                company_email: 'test@empresa.com'
            };

            const savedCompany = await this.database.saveCompanySettings(companySettings);
            this.addTestResult('Guardar configuraci√≥n de empresa', savedCompany.success, 'Configuraci√≥n de empresa guardada');

            // Probar configuraci√≥n de facturas
            const invoiceSettings = {
                invoice_prefix: 'TEST',
                invoice_start_number: 1,
                default_vat: 21,
                default_due_days: 30
            };

            const savedInvoice = await this.database.saveInvoiceSettings(invoiceSettings);
            this.addTestResult('Guardar configuraci√≥n de facturas', savedInvoice.success, 'Configuraci√≥n de facturas guardada');

            // Obtener configuraci√≥n
            const appSettings = await this.database.getAppSettings();
            this.addTestResult('Obtener configuraci√≥n', !!appSettings, 'Configuraci√≥n obtenida exitosamente');

        } catch (error) {
            this.addTestResult('Configuraci√≥n', false, error.message);
        }
    }

    async testDashboardStats() {
        console.log('\nüìä Probando estad√≠sticas del dashboard...');

        try {
            const stats = await this.database.getDashboardStats();
            const hasRequiredStats = stats && 
                typeof stats.totalClients === 'number' &&
                typeof stats.totalInvoices === 'number' &&
                typeof stats.pendingInvoices === 'number' &&
                typeof stats.totalRevenue === 'number' &&
                typeof stats.invoicesThisMonth === 'number';

            this.addTestResult('Estad√≠sticas del dashboard', hasRequiredStats, 
                hasRequiredStats ? `Estad√≠sticas: ${stats.totalClients} clientes, ${stats.totalInvoices} facturas` : 'Error en estad√≠sticas');

        } catch (error) {
            this.addTestResult('Estad√≠sticas del dashboard', false, error.message);
        }
    }

    addTestResult(testName, passed, message) {
        this.testResults.tests.push({
            name: testName,
            passed,
            message
        });

        if (passed) {
            this.testResults.passed++;
            console.log(`‚úÖ ${testName}: ${message}`);
        } else {
            this.testResults.failed++;
            console.log(`‚ùå ${testName}: ${message}`);
        }
    }

    showResults() {
        console.log('\n' + '='.repeat(60));
        console.log('üìã RESUMEN DE PRUEBAS');
        console.log('='.repeat(60));
        console.log(`‚úÖ Pruebas exitosas: ${this.testResults.passed}`);
        console.log(`‚ùå Pruebas fallidas: ${this.testResults.failed}`);
        console.log(`üìä Total de pruebas: ${this.testResults.tests.length}`);
        
        const successRate = ((this.testResults.passed / this.testResults.tests.length) * 100).toFixed(1);
        console.log(`üéØ Tasa de √©xito: ${successRate}%`);

        if (this.testResults.failed > 0) {
            console.log('\n‚ùå PRUEBAS FALLIDAS:');
            this.testResults.tests
                .filter(test => !test.passed)
                .forEach(test => {
                    console.log(`   ‚Ä¢ ${test.name}: ${test.message}`);
                });
        }

        console.log('\n' + '='.repeat(60));
        
        if (successRate >= 90) {
            console.log('üéâ ¬°Excelente! La aplicaci√≥n est√° funcionando correctamente.');
        } else if (successRate >= 70) {
            console.log('‚ö†Ô∏è La aplicaci√≥n funciona pero hay algunos problemas que necesitan atenci√≥n.');
        } else {
            console.log('üö® La aplicaci√≥n tiene problemas significativos que deben ser corregidos.');
        }
    }
}

// Ejecutar pruebas si se ejecuta directamente
if (require.main === module) {
    const tester = new AppTester();
    tester.runAllTests().then(() => {
        process.exit(0);
    }).catch(error => {
        console.error('Error en las pruebas:', error);
        process.exit(1);
    });
}

module.exports = AppTester;
